from aiogram.types import CallbackQuery
from core.keyboard_templates import KeyboardTemplates


async def handle_roo_structure(callback: CallbackQuery):
    """Обработчик структуры продаж и взаимодействия отделов"""
    import asyncio
    
    structure_text = """
Продажи автомобилей (а/м) с пробегом основываются на работе и взаимодействии следующих отделов и специалистов: 

ОТДЕЛ ПРОДАЖ
Задача: реализация автомобилей и услуг согласно стандартам, регламентам и миссии компании.
Структура:
• Руководитель отдела продаж
• Старший менеджер отдела продаж (если в отделе более 10 менеджеров)
• Менеджеры отдела продаж

ОТДЕЛ ОЦЕНКИ  
Задача: формирование ликвидного ассортимента торговой площадки на основании потребительского спроса в регионе.
Структура:
• Руководитель отдела оценки
• Старший менеджер отдела оценки (если в отделе более 10 экспертов-оценщиков)
• Эксперты-оценщики (стационарная оценка)
• Руководитель направления выездной оценки
• Эксперты выездной оценки

КОНТАКТЦЕНТР
Подразделение, занимающееся обработкой входящих обращений клиентов компании по различным каналам (звонки, электронная почта, мессенджеры, чат на сайте, соц.сети и др.).
Задача: обеспечение необходимого трафика для выполнения плана по наполнению склада и продажам
Структура:
• Руководитель контакт-центра
• Супервайзеры
• Менеджеры телефонных продаж

ОТДЕЛ F&I
Задача: реализация кредитных и страховых продуктов компании
Структура:
• Руководитель отдела F&I (если более 4 кредитных специалистов)
• Старший кредитный специалист (если в отделе менее 4 кредитных специалистов)
• Кредитные специалисты

ЕЦО (Единый центр оформления)
Подразделение, ответственное за оформление и документальное обеспечение любых видов сделок с физическими и юридическими лицами, работающее в режиме «одного окна». Сотрудники ЕЦО работают в удаленном режиме (не привязаны к регионам присутствия автосалонов).
Задача: оформления сделок, обеспечение документооборота и проведение финансовых операций по продажам 
Структура:
• Руководитель ЕЦО
• Старшие оформители
• Оформители

ОТДЕЛ ПРЕДПРОДАЖНОЙ ПОДГОТОВКИ 
Задача: обеспечение быстрой и качественной подготовки автомобилей в ритейл согласно стандартам и регламентам компании
Структура:
• Сток-менеджер
• Стайл-менеджер
Сток-менеджер взаимодействует с РОП и РОО по вопросам предпродажной подготовки а/м.

ОТДЕЛ КРИМИНАЛИСТИКИ
Задача: исключение финансовых и материальных потерь компании. РОП \РОО и ЭО взаимодействуют с отделом криминалистики по вопросам криминалистической проверки, в онлайн формате, при выкупе /постановке на комиссию а/м и продаже а/м
Структура:
• Старший криминалист
• эксперты-криминалисты

КОНТЕНТМЕНЕДЖЕРЫ 
Задача: обеспечение максимальной привлекательности объявлений компании на рекламных площадках (классифайдах)
РОП/РОО взаимодействуют с контент-менеджерами по вопросам съемки а/м на площадке

ОТДЕЛ МАРКЕТИНГА
Задача: продвижение бренда Fresh Auto в целом и конкретных автомобилей в частности. РОП / РОО взаимодействуют с отделом маркетинга по вопросам проведения акций, мероприятий, продвижения а/м на классифайдах.
Структура:
• Региональный бренд-менеджер
• Маркетолог
• Руководитель сектора продвижения на классифайдах

СЛУЖБА ГОСТЕПРИИМСТВА
Задача: поддержка клиентов до, во время и после того, как они покупают или используют продукты или услуги компании, а также когда они сталкиваются с проблемой
Структура:
• Руководитель службы гостеприимства
• Региональный руководитель службы гостеприимства

ЮРИДИЧЕСКАЯ СЛУЖБА
Задача: сопровождение и поддержка правовых отношений с клиентом.
По всем юридическим вопросам в юридическую службу можно обратиться через программу «Тезис» или заявку в CRM

СВК 
Задача: сохранность а/м на складе, оформление пропусков на выезд автомобиля
Структура:
• Старший смены

УПРАВЛЯЮЩАЯ  КОМПАНИЯ
Руководители всех отделов взаимодействует с руководителями своих направлений из УК. Для эффективного взаимодействия проводятся телефонные переговоры, встречи в Zoom, личные встречи.
"""
    
    # Отправляем первое сообщение со структурой отделов
    await callback.message.edit_text(structure_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем второе сообщение с текстом о взаимодействии и кнопкой "Назад"
    interaction_text = """
Качественное и эффективное взаимодействие сотрудников всех отделов ведет к главной цели компании – продажам.  Основными отделами, обеспечивающими выполнение планов продаж, являются Отдел продаж и Отдел оценки во главе с руководителем филиала. Остальные отделы обеспечивают поддерживающую функцию продаж.
"""
    keyboard_templates = KeyboardTemplates()
    keyboard = await keyboard_templates.get_cancel_keyboard()
    await callback.message.answer(interaction_text, reply_markup=keyboard)


async def handle_roo_functionality(callback: CallbackQuery):
    """Обработчик функционала РОО"""
    import asyncio
    
    # Первое сообщение
    first_text = """
Функционал Руководителя отдела нагляднее всего отображает его ежедневный график
"""
    await callback.message.edit_text(first_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Второе сообщение - Сценарий дня
    scenario_text = """
СЦЕНАРИЙ ДНЯ РОО

8:30
(пн)
Product Team Meeting
Собрание проводится по текущим вопросам, разбор показателей прошлой
недели, оценка показателей сотрудников, анализ промежуточных
показателей отделов и выработка предложений для внедрения в работу.
При наличии общих вопросов со смежными отделами к собранию могут быть
привлечены руководители отделов F&I, СВК, криминалисты, техники,
мастера-приемщики и другие по необходимости. Оцениваются следующие
показатели филиала в разрезе план / факт / отклонение:
• продажи а/м в штуках;
• соответствие модельному
миксу;
• план/факт в разрезе
выкуп/комиссия в шт.
(стационар);
• план/факт в разрезе
выкуп/комиссия в шт.
(выездная оценка);
• валовая выручка (кузов и
F&I);
• брокерские сделки;
• оборачиваемость
комиссионного склада
(висяки 60/90);
• конверсия визит/сделка;
• качество звонков;
• доля возвращенных
клиентов;
• NPS
"""
    await callback.message.answer(scenario_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Третье сообщение - Обход а/м
    walk_text = """
8:45 -09:15
(пн)
Обход а/м, вновь зашедших на склад
ЭО / РОО презентуют а/м, принятые на площадку в предыдущий день, для
ОП, делают обзор ключевых характеристик а/м, знание которых необходимо
для его продажи, например: история а/м, автотека, количество окрасов,
особенности комплектации внешний вид, наличие дополнительного
оборудования. Обход производится совместно с менеджерами ОП, РОО,
экспертами оценки, стайл-менеджером.

09:00 - Открытие кассового узла
Производит ответственный сотрудник: РОП, РОО, финансовый менеджер
либо другой сотрудник с согласованным доступом. В конце рабочего дня
происходит закрытие смены, пересчет денежных средств и контроль
заполнения отчетности.
"""
    await callback.message.answer(walk_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Четвертое сообщение - Отчет
    report_text = """
09:15 - 09:30
(пн)
Составление отчета о проделанной работе
Отчет заполняется из CRM и отправляется руководителю филиала.
Пример отчета в разделе «работа с отчетностью»

09:45 Ежедневная тренировка
Тренировка проводится на актуальные темы (входящий звонок стажера,
проработка популярных или сложных кейсов, осмотр а/м по регламенту,
работа с возражениями, презентация услуги комиссии, обмену, тренинг по
тех. части, криминалистике, работа с рекламациями). Тренинг проводит
РОО/СМОО. При необходимости привлекаются сотрудники смежных
отделов (РОО, ППП, СЦ, HR, F&I, СВК).
"""
    await callback.message.answer(report_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Пятое сообщение - Собрание руководителей
    meeting_text = """
11:00
(в пн)
Собрание руководителей
Участвуют РОП, РОО и руководитель филиала. Обсуждаются операционные
и стратегические вопросы, текущее выполнение плана на дату, раз в месяц
подводится итог по БДР, раз в квартал отчет по итогам работы ушедшего
квартала. При необходимости привлекаются другие сотрудники. Собрание
проводится каждый понедельник.

11:00 - 11:30
(в пн)
Осмотр поступивших вчера а/м, определение задач по ППП
РОП, РОО, стайл-менеджер и технический координатор совершают обход
вновь зашедших а/м и определяют перечень работ по каждому а/м:
косметических и технических.
Косметические работы обсуждаются со стайл-менеджером на площадке.
Стайл-менеджер берет их в работу и приступает к выполнению.
"""
    await callback.message.answer(meeting_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Шестое сообщение - Гибкие задачи
    flexible_text = """
12:00 – 21:00
Выполнение гибких задач
После завершения всех жестких задач РОО переходит к гибким задачам дня.
Эти же задачи может выполнять СЭО.
• контроль распределения заявок по менеджерам ОО из контакт-центра
и мессенджеров;
• прослушивание звонков менеджеров ОО для выявления некорректной
работы и разбор ошибок по горячим следам. Здесь РОО/СЭО и
эксперт оценки вместе прослушивают входящий звонок, РОО
выделяет зоны роста и указывает на ошибки при их наличии. РОО
может слушать звонки и в отсутствие эксперта оценки — в этом
случае он дает ему обратную связь после анализа звонка,
прорабатывает вместе с ним корректные варианты работы в случае
ошибок;
• анализ звонков и приездов от контакт-центра (КЦ) на основании
отчета супервайзера по звонкам и данным по приездам в CRM;
• контроль звонков экспертов оценки клиентам по информированию о
событиях (а/м поступил в рекламу, есть на классифайдах, знакомство
с обращениями по а/м, обсуждение цены а/м с комитентом), анализ
процесса ведения комитента, обозначение сроков дальнейшей связи;
• разбор ошибок, допускаемых в течение дня (несоблюдение этапов
работы с клиентом, неполная презентация продуктов компании и др.)
и проработка корректных вариантов работы по горячим следам;
• анализ наработок — РОО/СЭО совершает обход индивидуального
склада эксперта оценки вместе с ним, выясняет, знаком ли эксперт
оценки с историей своих а/м, подготовлен ли к отработке возражений
по ним, разбирает динамику запросов по а/м, проводит анализ работы
экспертов оценки с ценой своих а/м на складе, а также оценивает, как
выглядит склад, как качественно выполнена ППП.
• проведение дополнительных тест-драйвов с сотрудниками;
• РОО согласовывает стоимость а/м для экспертов оценки, основываясь
на анализе рынка, внутренних продаж и опыта. В его отсутствие этим
занимается РОП;
• координация и контроль текущей работы экспертов ОО согласно
поставленным на день задачам и должностной инструкции;
• обучение стажеров, контроль прохождения стажерами курса обучения
во Fresh Академии, подготовка стажеров к аттестации. Как правило,
СЭО занимается непосредственно процессом обучения, а РОО
проверяет подготовку стажера в контрольных точках;
• подписание пропусков сделке каждого эксперта ОО: РОО должен
убедиться, что менеджер ОО провел клиента в кассу, отдел сервиса,
отдел F&I, проверил автотеку в ОО и прошел с клиентом диагностику.
Подписание пропусков осуществляется лицами, утвержденными
руководителем филиала.
• в случае отсутствия координатора Отдела выездной оценки, РОО
координирует работу экспертов выездной оценки
"""
    await callback.message.answer(flexible_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Финальное сообщение без кнопки
    final_text = """
Формат планирования можно выбрать любой. Можно вести записи в ежедневнике либо в онлайн формате. Мы рекомендуем использовать Outlook. Так вы сможете подключать к задачам всех участников.
"""
    await callback.message.answer(final_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем первое фото
    photo1_id = "AgACAgIAAxkBAAPEaRZaA7vnQJ_pL82Kh6T7s4XzX84AAp8Maxstl7lIJy1Uh_O748UBAAMCAAN5AAM2BA"
    await callback.message.answer_photo(photo1_id)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем второе фото
    photo2_id = "AgACAgIAAxkBAAPGaRZaHrD9e3W5bckWNlE9k-LHBsQAAqAMaxstl7lIpZpf8PzlD4UBAAMCAAN5AAM2BA"
    await callback.message.answer_photo(photo2_id)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем финальное сообщение с кнопками
    final_message = "Давайте подробнее разберем задачи"
    keyboard_templates = KeyboardTemplates()
    tasks_keyboard = await keyboard_templates.get_tasks_keyboard()
    await callback.message.answer(final_message, reply_markup=tasks_keyboard)


async def handle_roo_competencies(callback: CallbackQuery):
    """Обработчик компетенций РОО"""
    competencies_text = """
Компетенции РОО, которые важны для работы
 и которые нужно развивать, можно разделить
 на 3 типа:
"""
    competencies_buttons = {
        "Корпоративные": "competencies_corporate",
        "Технические": "competencies_technical",
        "Управленческие": "competencies_management",
        "<- Назад": "back_to_main"
    }
    keyboard_templates = KeyboardTemplates()
    keyboard = await keyboard_templates.keyboard_ops.create_keyboard(competencies_buttons, interval=1)
    await callback.message.edit_text(competencies_text, reply_markup=keyboard)


async def handle_rop_functionality(callback: CallbackQuery):
    """Обработчик функционала РОП"""
    import asyncio
    
    # Первое сообщение
    first_text = """
Функционал Руководителя отдела нагляднее всего отображает его ежедневный график
"""
    await callback.message.edit_text(first_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Второе сообщение - Сценарий дня РОП
    scenario_text = """
СЦЕНАРИЙ ДНЯ РОПа

8:30
(пн)
Product Team Meeting (Встреча продуктивной команды)
Собрание проводится по текущим вопросам, разбор показателей прошлой
недели, оценка показателей сотрудников, анализ промежуточных
показателей отделов и выработка предложений для внедрения в работу.
При наличии общих вопросов со смежными отделами к собранию могут быть
привлечены руководители отделов F&I, СВК, техники, мастера-приемщики
и др. по необходимости.
Оцениваются следующие показатели филиала в разрезе план / факт /
отклонение:
• продажи а/м в штуках;
• валовая выручка (кузов и
F&I);
• ТО-0;
• продленная тех. защита
(ПТЗ);
• брокерские сделки;
• интерактивные продажи;
• оборачиваемость выкупного
склада;
• конверсия визит/сделка;
• отзывы покупателей;
• количество звонков; качество
звонков;
• доля trade-in;
• доля возвращенных клиентов
• NPS.
"""
    await callback.message.answer(scenario_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Третье сообщение - Обход а/м
    walk_text = """
08:45 -09:15
(пн)
Обход а/м, вновь зашедших на склад
ЭО / РОО презентуют а/м, принятые на площадку в предыдущий день, для
ОП, делают обзор ключевых характеристик а/м, знание которых необходимо
для его продажи, например: история а/м, автотека, количество окрасов,
особенности комплектации внешний вид, наличие дополнительного
оборудования. Обход производится совместно с менеджерами ОП, РОО,
экспертами оценки, стайл-менеджером.
"""
    await callback.message.answer(walk_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Четвертое сообщение - Отчет и тренировка
    report_text = """
09:15 - 09:30
(пн)
Составление отчета о проделанной работе и анализ наработок
Отчет заполняется из CRM «Отчет по продажам», после анализа наработок
они отправляются руководителю филиалов.

09:45 –10:45
Ежедневная тренировка по продажам
Тренировка проводится на актуальные темы (входящий звонок стажера,
проработка популярных или сложных кейсов, презентация а/м, работа с
возражениями, тренинг по тех. части). Тренинг проводит РОП/СМОП. Для
тренировки навыков продаж проводится практическое упражнение по
презентации новых а/м сотрудниками ОП, практическая отработка
возможных возражений и другие возможные упражнения.
"""
    await callback.message.answer(report_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Пятое сообщение - Собрание руководителей и обход с ППП
    meeting_text = """
11:00
(в пн)
Собрание руководителей
Участвуют РОП, РОО и руководитель филиала. Обсуждаются операционные
и стратегические вопросы, текущее выполнение плана на дату, раз в месяц
подводится итог по БДР, раз в квартал отчет по итогам работы ушедшего
квартала. При необходимости привлекаются другие сотрудники. Собрание
проводится каждый понедельник.

11:00 -11:30
Обход с отделом ППП и техническим координатором
РОП, РОО, стайл-менеджер и технический координатор совершают обход
вновь зашедших а/м и определяют перечень работ по каждому а/м:
косметических и технических.
РОП принимает решение о проведении работ, согласно регламенту
Предпродажной подготовки. Косметические работы обсуждаются со стайлменеджером на площадке. Стайл-менеджер берет их в работу и приступает к
выполнению.
"""
    await callback.message.answer(meeting_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Шестое сообщение - Встреча с техническим координатором
    tech_text = """
11:30- 12:00
(в пн)
Встреча РОП с техническим координатором
Технические работы обсуждаются более детально лично с техническим
координатором после обхода по каждому а/м у компьютера: нужно ли
провести ТО, поменять стойки/резину и пр.
Здесь же производится анализ оценки а/м, произведенной экспертомоценщиком накануне. РОП на обходе обязан проверить, какой перечень работ
необходим по а/м для его продажи, и какой перечень работ включил в
стоимость а/м эксперт оценки во время приема а/м на площадку.
Себестоимость а/м, указанная экспертом оценки, должна включать
стоимость необходимых вложений в а/м для его успешной реализации.
В случае если не все расходы были учтены экспертом оценки и конечная
стоимость а/м на площадке некорректна, РОП и РОО составляют
соответствующий акт в свободной форме, а возмещение расходов берет на
себя эксперт оценки как материально ответственный сотрудник,
совершивший ошибку в просчетах.
"""
    await callback.message.answer(tech_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Седьмое сообщение - Гибкие задачи
    flexible_text = """
12:00 – 21:00
Выполнение гибких задач. Операционная работа РОП/СМОП
с сотрудниками
После завершения всех жестких задач РОП переходит к гибким задачам дня.
Эти же задачи может выполнять СМОП.
• контроль распределения заявок по менеджерам ОП из контактцентра и мессенджеров;
• прослушивание звонков менеджеров ОП для выявления
некорректной работы и разбор ошибок по горячим следам. Здесь
РОП/СМОП и менеджер ОП вместе прослушивают входящий
звонок, РОП/СМОП выделяет зоны роста и указывает на ошибки
при их наличии. РОП/СМОП может слушать звонки и в отсутствие
конкретного МОП — в этом случае он дает ему обратную связь
после анализа звонка, прорабатывает вместе с ним корректные
варианты работы в случае ошибок;
• разбор ошибок, допускаемых в течение дня (несоблюдение этапов
продаж, неполная презентация продуктов компании и др.) и
проработка корректных вариантов работы по горячим следам;
• анализ наработок — РОП/СМОП выясняет, знаком ли менеджер ОП
с историей своих а/м, подготовлен ли к отработке возражений по
ним;
• проведение дополнительных тест-драйвов с сотрудниками;
• РОП/СМОП согласовывает условия продажи а/м согласно
процедуре ценообразования и плану по рентабельности,
установленного руководителем филиала на основании БДР. В
случае, если а/м комиссионный, РОП/СМОП согласовывает
стоимость с РОО.
• координация и контроль текущей работы МОП согласно
поставленным на день задачи и должностной инструкции;
• подписание пропусков по сделке каждого менеджера ОП: РОП
должен убедиться, что менеджер ОП провел клиента в кассу, отдел
сервиса, отдел F&I, проверил автотеку в ОО и прошел с клиентом
диагностику. Подписание пропусков осуществляется лицами,
утвержденными руководителем филиала.
"""
    await callback.message.answer(flexible_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Финальное сообщение без кнопки
    final_text = """
Формат планирования можно выбрать любой. Можно вести записи в ежедневнике либо в онлайн формате. Мы рекомендуем использовать Outlook. Так вы сможете подключать к задачам всех участников.
"""
    await callback.message.answer(final_text)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем первое фото
    photo1_id = "AgACAgIAAxkBAAPAaRZZfKUQ9GypYHhHnjIHw4qjCNgAAp0Maxstl7lILmAvzwG-hkABAAMCAAN5AAM2BA"
    await callback.message.answer_photo(photo1_id)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем второе фото
    photo2_id = "AgACAgIAAxkBAAPCaRZZv452-QWRJYL8qRg3yAgOPMYAAp4Maxstl7lIPSNPVElRPtMBAAMCAAN5AAM2BA"
    await callback.message.answer_photo(photo2_id)
    
    # Задержка 3 секунды
    await asyncio.sleep(3)
    
    # Отправляем финальное сообщение с кнопками
    final_message = "Давайте подробнее разберем задачи"
    keyboard_templates = KeyboardTemplates()
    tasks_keyboard = await keyboard_templates.get_tasks_keyboard()
    await callback.message.answer(final_message, reply_markup=tasks_keyboard)


async def handle_search(callback: CallbackQuery):
    """Обработчик кнопки поиска"""
    from handlers.search import handle_search_button
    
    # Вызываем обработчик без state (state будет получен автоматически через middleware)
    await handle_search_button(callback)

